---
title: "Isochrones 101: \"How far is everything?\""
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

<br>

<center>

![Going places!](Rplot_title.png)

</center>

## Objective:

Now that we've discussed what isochrones are and how we could use them, let's follow along on a coding example and create our own  transit isochrone from Jay St. Metrotech!

## Requirements:

1.  [R](https://cran.r-project.org/bin/windows/base/) and ideally [R Studio](https://posit.co/download/rstudio-desktop/)

2.  [Java 11 SDE](https://adoptium.net/temurin/releases/?version=11), needed to run our routing engine R5. The .msi (Windows) or .pkg files (Mac) will simplify the installation process; a restart may be required after installation. **Sidenote: you'll need Java 11; if you have other versions of Java installed, you'll need to temporarily update your user JAVA_HOME variable to point to Java 11.** 
    
3.  R Packages 

    -   r5r - Rapid Realistic Routing on Real-World and Reimagined Networks -- our isochrone generator
    -   sf - for spatial work in R
    -   tidyverse - Cleaning dataframes.
    -   tidytransit - Helps us read GTFS feeds.
    -   mapview - Spatial visualization made easy.
    
If you don't already have these packages, uncomment the line below and run the following items to install them. 

```{r message=FALSE, warning=FALSE, include=FALSE}
# install.packages(c('r5r','sf','tidyverse','tidytransit','mapview'))
```

## Data:

For ease of use, we've included required data within this repository.

1.  [NYC OpenStreetMap Data which we've filtered (you can use your own
    .pbf files for your own analysis!)](https://github.com/vpeter-fitp/isochrones_tcnyc2023/blob/main/data/nyc.pbf)
2.  [NYC Subway GTFS Feed from Transit.Land (for this demonstration,
    we've provided the file
    here.)](https://github.com/vpeter-fitp/isochrones_tcnyc2023/blob/main/data/nyctsubway.zip)

## You can download the data and run these snippets by yourself!

Now let's jump into the demonstration.

## Setup

Now we load them:

```{r message=FALSE, warning=FALSE}
suppressPackageStartupMessages({
  # we set the amount of memory (8G) usable by Java before loading r5
  options(java.parameters = "-Xmx8G")
  library(r5r)
  library(sf)
  library(tidyverse)
  library(tidytransit)  
})

```

## Initiating r5, our Routing Engine

The routing engine (r5) needs something to route on. So let's point it to datasets it can use to build a network. 

For convenience, we keep all of the required files for this demo in the repository. If your current working directory isn't already the repository folder, set or otherwise update the path here. 

```{r}
data_path <- getwd()
```

- For the street network, you can use the demo '.pbf' file that gives the routing engine the required data from Open Street Map. This file was obtained from [Geofabrik's OpenStreetMap exports](https://download.geofabrik.de/) and pre-processed to clip it to an area around New York City.
- For the transit network, we'll use the provided GTFS file for the subway.

The code below will use the .pbf and GTFS files and create the network file if it doesn't already exist. 

```{r message=FALSE, warning=FALSE}
r5r_core <- setup_r5(data_path, verbose = TRUE)
```
The routing engine uses this .pbf and GTFS data to create a 'Network' file. 

Here's what it looks like:

!['Our precious network file'](thatnetworkfilepic.jpg)

## Importing GTFS data into R

We'll use GTFS data not only to build our network, but also as a source of data for visualizations and starting points for our isochrone.

In R, we can use the tidytransit package to load the GTFS file and make it easier for us to work with it.

```{r}
gtfs_base <- tidytransit::read_gtfs(file.path(data_path,'nyctsubway.zip'))
```

Before we continue, let's look at and think about the applications of experimenting with this GTFS data.

![view(gtfs_base)](viewgtfs.png)

While there's much to work with in a GTFS feed, here we're only focused on plotting the location of subway station stops. We'll extract the latitude and logitude of our stops, performing a slight bit of renaming and aggregation to fit the needs of r5r.

```{r}
stops <- 
  gtfs_base$stops %>%
  select(
    stop_name, 
    id = parent_station, 
    lat = stop_lat, 
    lon = stop_lon
  ) %>% 
  # Taking shortcuts to quickly pick a point for a station
  group_by(id) %>%
  filter(row_number()==1) %>% 
  ungroup()
```

## Where are we?

Let's find out where we can start our isochrone search from. The centre.

![view(stops)](jayst.png)

Based, on this, let's start at Jay St. Metrotech.

```{r}
central_point <- 
  stops %>% 
  filter(
    id == "A41" # This is one of the Jay St. Metrotech IDs.
  ) 
```

## The Legend

The first and second parameters are the lower and upper timing limits respectively for visualization. The third value is the change step.

```{r}
time_intervals <- seq(0, 45, 5)
```

### Specifying our Parameters for the Search

We'll specify additional parameters below
```{r}
mode <- c("WALK", "TRANSIT")
max_walk_time <- 15      
max_trip_duration <- 60
time_window <- 60       
departure_datetime <- lubridate::ymd_hms("2023-10-10 09:00:00")
```

### Let's Run the Engine!

```{r message=FALSE, warning=FALSE}
isochrone_result <- 
  r5r::isochrone(
    r5r_core,
    origins = central_point,
    mode = mode,
    mode_egress = "WALK",
    cutoffs = time_intervals,
    sample_size = 1,
    departure_datetime = departure_datetime,
    max_walk_time = max_walk_time,
    max_trip_duration = max_trip_duration,
    time_window = time_window,
    progress = FALSE,
    verbose = FALSE
  )
```

### Creating the NYC Subway Stops for Visualization

The generated isochrone_result needs to be visualized. We'll convert our stops file to a spatial layer we can visualize.

```{r}
stops_sf <- st_as_sf(stops, coords = c("lon","lat"), crs = 4326L, remove = FALSE)
```

 
To finally arrive at:

```{r}
mapview::mapview(
    stops_sf,
    zcol = 'stop_name',
    legend = FALSE,
    alpha.regions = 0.02,
    col.regions = 'blue',
    cex = 3,
    lwd=0.5
  ) +
mapview::mapview(
  isochrone_result, 
  zcol = "isochrone", 
  alpha.regions = 0.25 # sets the opacity of items 
) + 
  mapview::mapview(
    {stops_sf %>% filter(id == "A41")},
    zcol = 'stop_name',
    legend = FALSE,
    col.regions = 'red',
    lwd=0.5
  )
```

# Congratulations!

You've just developed your first isochrone!

We'd recommend you try this out for areas that are special or cool to you! Or simply see how the transit systems affect it.

### Thanks for joining us today!

We'd be more than happy to run through this demo with you!
OR
Reach out if you'd ever want to discuss transit data!

Our inbox is always open at:

* [Wylie Timmerman, Senior Transportation Planner & Data Science Team Technical Lead](https://www.foursquareitp.com/staff/wylie-timmerman/)

* [Vickram Peter, Transportation Planner & Data Scientist](https://www.foursquareitp.com/staff/vickram-peter/)
